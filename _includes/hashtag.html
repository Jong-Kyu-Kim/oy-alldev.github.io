<script>
    function filterByTagName(tagName) {
        $('.hidden').removeClass('hidden');
        $('.catalogue-item').each((index, elem) => {
            console.log(elem.hasAttribute(`data-${tagName}`))
            if (!elem.hasAttribute(`data-${tagName}`)) {
                $(elem).addClass('hidden');
            }
        });
        $(`.tag`).removeClass('selected');
        $(`.tag[data-tag=${tagName}]`).addClass('selected');
    }

    function updateQueryString(tagName) {
        const path = `${location.protocol}//${location.host}${location.pathname}?tag=${tagName}`;
        window.history.replaceState({ path }, '', path);
    }

    function sortTag(a,b){
        a = $(a).attr("data-tag");
        b = $(b).attr("data-tag");
        if(a > b) {
            return 1;
        } else if(a < b) {
            return -1;
        } else {
            return 0;
        }
    };

    function makeTagList(){
        let $tags = $(".tag");
        const tags = [];
        for(let v of $tags){
            const repTagText = $(v).text().replace(/\s/gi, "");
            if(tags.indexOf(repTagText) < 0) {
                tags.push(repTagText);
                $("#tag-list")[0].innerHTML += `<span class="tag" data-tag="${repTagText}"> ${repTagText} </span>`
            }
        }
        $('#tag-list span').sort(sortTag).appendTo('#tag-list');
    }

    function getAllTagList() {
        const $tags = Array.prototype.slice.call($('#tag-list span'))
        const result = [];
        for(let v of $tags) {
            const repTagText = $(v).text().replace(/\s/gi, "");
            result.push(repTagText)
        }
        return result;
    }

    function linkTag(){
        const queryTag = window.location.search.substring(5);
        const tags = getAllTagList();
        if (queryTag && tags.includes(queryTag)) {
            filterByTagName(queryTag);
        }
    }

    function tagFilter(){
        makeTagList();
        linkTag();
        $(`[data-tag]`).click((e) => {
            const currentTag = e.target.dataset.tag;
            filterByTagName(currentTag);
            updateQueryString(currentTag);
        })
    }

    $(document).ready(function() {
        tagFilter();
    });
</script>

<div id="tag-list" class="tag-list"></div>